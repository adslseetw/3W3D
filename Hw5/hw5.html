<!DOCTYPE html>
<html>
<head>
<style>
#info {
	position: absolute;
	top: 0px; width: 60%;
	font-family: Monospace;
	font-size: 20px;
	padding: 5px;
	text-align: center;
	color: #FF8000
}

#container {
    width:60vw;
	height:10vw;
    float:left;
    background-color:black;
    margin-top: 0px;
	padding-bottom:100%;
}
#canvasFrame {
    padding-bottom:100%;
}
.flc {
    margin:10px;
	margin-top:30px;
    width:13%;
	float:left;
}
body {
     position: fixed;
	 overflow:hidden;
}

	strong {color: red}
</style>
</head>
<body>
<div id="container">
    <div id="canvasFrame">
        <canvas id="canvas"></canvas>
    </div>
</div>

<div style="margin: 10px;  height:px; float:left">
<button id="saveBtn" style="margin:10px;">Save</button>
<button id="loadBtn"style="margin:10px">Load</button>
<button id="clearBtn"style="margin:10px">Clear Local Storage</button>
<button id="refreshBtn"style="margin:10px">Reload Page</button>
</div>

<img src="../images/Hw5/1.jpg" class="flc" onclick="javascript:putPicture(1);" />
<img src="../images/Hw5/2.jpg" class="flc" onclick="javascript:putPicture(2);" />
<img src="../images/Hw5/3.jpg" class="flc" onclick="javascript:putPicture(3);" />
<img src="../images/Hw5/4.jpg" class="flc" onclick="javascript:putPicture(4);" />
<img src="../images/Hw5/5.jpg" class="flc" onclick="javascript:putPicture(5);" />
<div style="clear:both"></div>

 <div id="info">hw5  <br/>點選右側圖片後點選灰色區塊即可掛上照片</div> 
<script src="../js/three.min.js"></script>
<script src="../js/OrbitControls.js"></script> 
<script src="../js/KeyboardState.js"></script>
<script src="../js/jquery-1.11.3.min.js"></script>


<script>
var camera, scene, renderer, geometry, material, spotLight, controls;
var texture1,texture2,texture3,texture4,texture5;
var keyboard = new KeyboardState();
var raycaster;
var mouse = new THREE.Vector2();
var pickables = [];
init();
animate();

function init() {

	var theCanvas = document.getElementById("canvas");
    var theCanvasFrame = document.getElementById("canvasFrame");
	renderer = new THREE.WebGLRenderer({
        canvas: theCanvas,
        antialias: true
    });
    width = theCanvasFrame.clientWidth;
    heigh = theCanvasFrame.clientHeight;
    renderer.setSize(width, heigh);
    renderer.setClearColor(0x888888);
	
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(50, heigh / heigh, 1, 1000);
    camera.position.z = 200;
    scene.add(camera);
	
	//-------------------------------------------------------------------
	
	texture1 = THREE.ImageUtils.loadTexture('../images/Hw5/1.jpg');
    texture2 = THREE.ImageUtils.loadTexture('../images/Hw5/2.jpg');
    texture3 = THREE.ImageUtils.loadTexture('../images/Hw5/3.jpg');
    texture4 = THREE.ImageUtils.loadTexture('../images/Hw5/4.jpg');
	texture5 = THREE.ImageUtils.loadTexture('../images/Hw5/5.jpg');
	var lamp_map = THREE.ImageUtils.loadTexture('../images/Hw3/lamp.jpg');
	var colormap = THREE.ImageUtils.loadTexture('../images/Hw2/texture_wood.png');

	
	
	    // lamp parameters--------------------------------------
    ly = 300;
    rt = 40;
    h = 80;
    alpha = Math.PI / 6;
    var rb = rt + h * Math.tan(alpha);

    geometry = new THREE.CylinderGeometry(rt, rb, h, 20, 1, true);
    material3 = new THREE.MeshPhongMaterial({
        side: THREE.DoubleSide,
		map: lamp_map
    });
    mesh_lamp = new THREE.Mesh(geometry, material3);
    mesh_lamp.position.setY(-h / 2); // so that top face is on XZ plane

    lamp = new THREE.Object3D();
    lamp.add(mesh_lamp);
    lamp.position.setY(ly);
    scene.add(lamp);
 
    // spotlight
    spotLight = new THREE.SpotLight(0xffffff, 1.5);
    spotLight.position.set(0, ly, 0);
    spotLight.angle = alpha;
    spotLight.exponent = 30;
    spotLight.castShadow = true;
    spotLight.shadowCameraNear = 10;
	spotLight.shadowCameraFar = camera.far;
	spotLight.shadowCameraFov = 30;  // in degrees
	spotLight.shadowBias = -0.00022;
	spotLight.shadowDarkness = 0.5;
	spotLight.shadowMapWidth = 2048;
	spotLight.shadowMapHeight = 2048;
	scene.add( spotLight );

	// ground
    var groundTexture = new THREE.ImageUtils.loadTexture( '../images/Hw2/texture_wood.png' );
	var groundMaterial = new THREE.MeshLambertMaterial( { map: groundTexture, side: THREE.DoubleSide } );
    var ground = new THREE.Mesh(new THREE.PlaneGeometry(500, 500, 40, 40),
    groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

	//-----------------------------------------------------------------------------
	var wall = new THREE.Object3D();
    geometry = new THREE.BoxGeometry(100, 100,5);
    material = new THREE.MeshLambertMaterial({
        side: THREE.DoubleSide,
		map: colormap
    });
	
	
    material1 = new THREE.MeshBasicMaterial({
        color: 0xCCCCCC,
        polygonOffset: true,
        polygonOffsetUnits: -2.0,
        polygonOffsetFactor: -1.0,
        //side: THREE.DoubleSide
    });
    geometry1 = new THREE.PlaneGeometry(15, 15); //畫
	
	mesh_Wall1 = new THREE.Mesh(geometry, material);
	mesh_Wall2 = new THREE.Mesh(geometry, material);
	mesh_Wall3 = new THREE.Mesh(geometry, material);
	
	mesh_Plane1 = new THREE.Mesh(geometry1, material1);
	mesh_Plane2 = new THREE.Mesh(geometry1, material1);
    mesh_Plane3 = new THREE.Mesh(geometry1, material1);
    mesh_Plane4 = new THREE.Mesh(geometry1, material1);
    mesh_Plane5 = new THREE.Mesh(geometry1, material1);
    mesh_Plane6 = new THREE.Mesh(geometry1, material1);
	
	mesh_Wall1.castShadow = true;
	mesh_Wall2.castShadow = true;
	mesh_Wall3.castShadow = true;
	mesh_Plane1.castShadow = true;
	mesh_Plane2.castShadow = true;
	mesh_Plane3.castShadow = true;
	mesh_Plane4.castShadow = true;
	mesh_Plane5.castShadow = true;
	mesh_Plane6.castShadow = true;
	
	mesh_Wall1.position.set(-100, 50, 50);
	mesh_Wall2.position.set(100, 50, 50);
	mesh_Wall3.position.set(0, 50, -2.5);

	mesh_Wall1.rotation.y = mesh_Plane1.rotation.y = mesh_Plane3.rotation.y = Math.PI / 4;
	mesh_Wall2.rotation.y = mesh_Plane2.rotation.y = mesh_Plane4.rotation.y = -1*Math.PI / 4;
	
	mesh_Plane1.position.set(-100, 25, 54);
	mesh_Plane2.position.set(100, 25, 54);
    mesh_Plane3.position.set(-100, 75, 54);
    mesh_Plane4.position.set(100, 75, 54);
    mesh_Plane5.position.set(25, 50, 0);
    mesh_Plane6.position.set(-25, 50, 0);
	
	mesh_Plane1.name = "mesh_Plane1";
	mesh_Plane2.name = "mesh_Plane2";
    mesh_Plane3.name = "mesh_Plane3";
    mesh_Plane4.name = "mesh_Plane4";
    mesh_Plane5.name = "mesh_Plane5";
    mesh_Plane6.name = "mesh_Plane6";
	
	wall.add(mesh_Plane1)
	wall.add(mesh_Plane2)
	wall.add(mesh_Wall2)
	wall.add(mesh_Wall1);
    wall.add(mesh_Wall3);
    wall.add(mesh_Plane3);
    wall.add(mesh_Plane4);
    wall.add(mesh_Plane5);
    wall.add(mesh_Plane6);
    scene.add(wall);
	
	picture = new THREE.Mesh(
    new THREE.PlaneGeometry(48, 24),
    new THREE.MeshBasicMaterial({
        map: texture1,
        //side: THREE.DoubleSide,
        polygonOffset: true,
        polygonOffsetUnits: -10.0,
        polygonOffsetFactor: -6.0,
    }));
	
    picture1 = new THREE.Mesh(
    new THREE.PlaneGeometry(40, 26),
    new THREE.MeshBasicMaterial({
        map: texture2,
        //side: THREE.DoubleSide,
        polygonOffset: true,
        polygonOffsetUnits: -10.0,
        polygonOffsetFactor: -5.0,
    }));
	
    picture2 = new THREE.Mesh(
    new THREE.PlaneGeometry(48, 36),
    new THREE.MeshBasicMaterial({
        map: texture3,
        //side: THREE.DoubleSide,
        polygonOffset: true,
        polygonOffsetUnits: -10.0,
        polygonOffsetFactor: -4.0,
    }));
	
    picture3 = new THREE.Mesh(
    new THREE.PlaneGeometry(48, 27),
    new THREE.MeshBasicMaterial({
        map: texture4,
        //side: THREE.DoubleSide,
        polygonOffset: true,
        polygonOffsetUnits: -10.0,
        polygonOffsetFactor: -3.0,
    }));
	
	picture4 = new THREE.Mesh(
    new THREE.PlaneGeometry(48, 27),
    new THREE.MeshBasicMaterial({
        map: texture5,
        //side: THREE.DoubleSide,
        polygonOffset: true,
        polygonOffsetUnits: -10.0,
        polygonOffsetFactor: -2.0,
    }));
	
	var amblight = new THREE.AmbientLight(0x888888); // soft white light
    scene.add(amblight);
	
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    pickables = [mesh_Plane3, mesh_Plane4, mesh_Plane5, mesh_Plane6,mesh_Plane1, mesh_Plane2];
    raycaster = new THREE.Raycaster();
	renderer.shadowMapEnabled = true;
	renderer.shadowMapType = THREE.PCFShadowMap;
    document.addEventListener('mousedown', onDocumentMouseDown, false);
    document.addEventListener('mousemove', onDocumentMouseMove, false);

    window.addEventListener('resize', onWindowResize, false);
    // the following is not needed for "embed" mode
    // document.body.appendChild(renderer.domElement);
}

function animate() {
    controls.update();
    requestAnimationFrame(animate);
    render();
}

function render() {
    renderer.render(scene, camera);
}


function onDocumentMouseDown(event) {

    event.preventDefault();
    mouse.x = (event.clientX / width) * 2 - 1;
    mouse.y = -((event.clientY - 15) / heigh) * 2 + 1;

    // find intersections
    var vector = new THREE.Vector3(mouse.x, mouse.y, 1).unproject(camera);

    raycaster.set(camera.position, vector.sub(camera.position).normalize());
    var intersects = raycaster.intersectObjects(pickables);

    if (intersects.length > 0) {
        if (intersects[0].object.name === "mesh_Plane3" && pic != undefined) {
            pic.position.copy(mesh_Plane3.position);
        }
        if (intersects[0].object.name === "mesh_Plane4" && pic != undefined) {
            pic.position.copy(mesh_Plane4.position);
        }
        if (intersects[0].object.name === "mesh_Plane5" && pic != undefined) {
            pic.position.copy(mesh_Plane5.position);
        }
        if (intersects[0].object.name === "mesh_Plane6" && pic != undefined) {
            pic.position.copy(mesh_Plane6.position);
        }
		if (intersects[0].object.name === "mesh_Plane1" && pic != undefined) {
            pic.position.copy(mesh_Plane1.position);
        }
		if (intersects[0].object.name === "mesh_Plane2" && pic != undefined) {
            pic.position.copy(mesh_Plane2.position);
        }
		
		scene.add(pic);
		pic.rotation.copy(intersects[0].object.rotation);
		if (tmp === 1) {
			picture.position.copy(pic.position);
			picture.rotation.copy(intersects[0].object.rotation);
		} else if (tmp === 2) {
			picture1.position.copy(pic.position);
			picture1.rotation.copy(intersects[0].object.rotation);
		} else if (tmp === 3) {
			picture2.position.copy(pic.position);
			picture2.rotation.copy(intersects[0].object.rotation);
		} else if (tmp === 4) {
			picture3.position.copy(pic.position);
			picture3.rotation.copy(intersects[0].object.rotation);
		}else if (tmp === 5) {
			picture4.position.copy(pic.position);
			picture4.rotation.copy(intersects[0].object.rotation);
		}

    }
}


function onDocumentMouseMove(event) {
    event.preventDefault();
    mouse.x = (event.clientX / width) * 2 - 1;
    mouse.y = -((event.clientY-15) / heigh) * 2 + 1;

    //
    var vector = new THREE.Vector3(mouse.x, mouse.y, 1).unproject(camera);
    raycaster.set(camera.position, vector.sub(camera.position).normalize());
    var intersects = raycaster.intersectObjects(pickables);

    if (intersects.length > 0) {
        document.body.style.cursor = 'pointer';
    } else {
        document.body.style.cursor = 'auto';
    }
}


var pmaterial1;
var tmp;

function putPicture(which) {

    if (which === 1) {
        pic = picture;
        tmp = 1;

    } else if (which === 2) {
        pic = picture1;
        tmp = 2;

    } else if (which === 3) {
        pic = picture2;
        tmp = 3;

    } else if (which === 4) {
        pic = picture3;
        tmp = 4;
    } else if (which === 5) {
        pic = picture4;
        tmp = 5;
    }
}

function onWindowResize() {

    width = theCanvasFrame.clientWidth;
    heigh = theCanvasFrame.clientHeight;
    camera.aspect = width / heigh;
    camera.updateProjectionMatrix();
    renderer.setSize(width , heigh);
}

$("#saveBtn").click(function () {
    var obj, obj1, obj2,obj3,obj4;
    obj = picture;    
    var objStr = JSON.stringify(obj);
    localStorage.setItem("myPicture1", objStr);
	localStorage.setItem("rotation1", picture.rotation.y);
    obj1 = picture1;    
    var objStr1 = JSON.stringify(obj1);
    localStorage.setItem("myPicture2", objStr1);
    localStorage.setItem("rotation2", picture1.rotation.y);
    obj2 = picture2;    
    var objStr2 = JSON.stringify(obj2);
    localStorage.setItem("myPicture3", objStr2);
    localStorage.setItem("rotation3", picture2.rotation.y);
    obj3 = picture3;    
    var objStr3 = JSON.stringify(obj3);
    localStorage.setItem("myPicture4", objStr3);
    localStorage.setItem("rotation4", picture3.rotation.y);
    obj4 = picture4;    
    var objStr4 = JSON.stringify(obj4);
    localStorage.setItem("myPicture5", objStr4);
    localStorage.setItem("rotation5", picture4.rotation.y);
});

$("#loadBtn").click(function () {
	var objStr,objStr1,objStr2,objStr3,objStr4; 
	var obj,obj1,obj2,obj3,obj4;
	var rotation1,rotation2,rotation3,rotation4,rotation5;
	
    objStr = localStorage.getItem("myPicture1");
    objStr1 = localStorage.getItem("myPicture2");
    objStr2 = localStorage.getItem("myPicture3");
    objStr3 = localStorage.getItem("myPicture4");
	objStr4 = localStorage.getItem("myPicture5");

	obj = obj1 = obj2 = obj3 = obj4 = null;

	rotation1 = localStorage.getItem("rotation1");
	rotation2 = localStorage.getItem("rotation2");
	rotation3 = localStorage.getItem("rotation3");
    rotation4 = localStorage.getItem("rotation4");
	rotation5 = localStorage.getItem("rotation5");
	
    try {
	  obj = JSON.parse(objStr); { picture.position.set(obj.object.matrix[12],obj.object.matrix[13],obj.object.matrix[14]); picture.rotation.y=rotation1;}
	  obj1 = JSON.parse(objStr1);{ picture1.position.set(obj1.object.matrix[12],obj1.object.matrix[13],obj1.object.matrix[14]);picture1.rotation.y=rotation2;}
	  obj2 = JSON.parse(objStr2);{ picture2.position.set(obj2.object.matrix[12],obj2.object.matrix[13],obj2.object.matrix[14]);picture2.rotation.y=rotation3;}
	  obj3 = JSON.parse(objStr3);{ picture3.position.set(obj3.object.matrix[12],obj3.object.matrix[13],obj3.object.matrix[14]);picture3.rotation.y=rotation4;}
	  obj4 = JSON.parse(objStr4);{ picture4.position.set(obj4.object.matrix[12],obj4.object.matrix[13],obj4.object.matrix[14]);picture4.rotation.y=rotation5;}
      if(picture.position.x !=0 || picture.position.z!=0 || picture.position.z!=0)
          scene.add(picture);
      if(picture1.position.x !=0 || picture1.position.z!=0 || picture1.position.z!=0)
          scene.add(picture1);
      if(picture2.position.x !=0 || picture2.position.z!=0 || picture2.position.z!=0)
          scene.add(picture2);
      if(picture3.position.x !=0 || picture3.position.z!=0 || picture3.position.z!=0)
          scene.add(picture3);
	  if(picture4.position.x !=0 || picture4.position.z!=0 || picture4.position.z!=0)
          scene.add(picture4);
       }
    catch (e) {
        //throw a exception if parse null to json
        alert(objStr);
    }
});

$("#clearBtn").click(function(){
    //clearBtn all records
    localStorage.clearBtn();
});

$("#refreshBtn").click(function(){
    window.location.reload();
});
</script>

</body>

</html>